{% extends "basic.html" %}

{% block title %}üåä H·ªá th·ªëng gi√°m s√°t ƒëu·ªëi n∆∞·ªõc{% endblock %}

{% block content %}
<div class="logout-container" style="position: fixed; top: 20px; right: 20px;">
    <form id="logout-form" action="{{ url_for('auth.logout') }}" method="POST" style="display: inline;">
        <button type="submit" class="logout-button">üö™ ƒêƒÉng xu·∫•t</button>
    </form>
</div>

<h1 class="title">üåä H·ªá th·ªëng gi√°m s√°t ƒëu·ªëi n∆∞·ªõc</h1>

<!-- ƒê√®n c·∫£nh b√°o -->
<div class="status-container">
    <div id="status-green" class="status-light green active" aria-live="polite" role="status">
        <div class="icon" aria-hidden="true">‚úÖ</div>
        <div class="label">B√¨nh th∆∞·ªùng</div>
    </div>
    <div id="status-red" class="status-light red" aria-live="polite" role="alert">
        <div class="icon" aria-hidden="true">üö®</div>
        <div class="label">Nguy hi·ªÉm</div>
    </div>
</div>

<!-- Link xem th·ªëng k√™ -->
<div class="email-log-link">
    <button id="view-email-stats" class="email-button">üìß Xem th·ªëng k√™ email c·∫£nh b√°o</button>
</div>

<!-- H·ªôp th·ªëng k√™ -->
<div id="email-stats-box">
    <div class="header">
        <strong>Email c·∫£nh b√°o g·∫ßn nh·∫•t</strong>
        <button class="close-btn" onclick="closeStatsBox()">‚úñ</button>
    </div>
    <div class="content">
        <div>üìß <span id="email-address"></span></div>
        <div>üìÑ <span id="email-content"></span></div>
        <div>üïí <span id="email-date"></span></div>
    </div>
</div>

<!-- Camera -->
<div class="camera-container" aria-label="Camera tr·ª±c ti·∫øp">
    <h2>üìπ Camera tr·ª±c ti·∫øp</h2>
    <img src="{{ url_for('views.video_feed') }}" alt="Camera tr·ª±c ti·∫øp" class="camera-feed" />
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        // G·ªçi API /status ƒë·ªÉ l·∫•y tr·∫°ng th√°i ƒëu·ªëi n∆∞·ªõc
        function fetchStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => updateStatus(data.is_drowning))
                .catch(error => console.error('‚ùå L·ªói khi fetch /status:', error));
        }

        // C·∫≠p nh·∫≠t ƒë√®n c·∫£nh b√°o theo tr·∫°ng th√°i
        function updateStatus(isDrowning) {
            const green = document.getElementById('status-green');
            const red = document.getElementById('status-red');
            if (isDrowning) {
                green.classList.remove('active');
                red.classList.add('active');
            } else {
                red.classList.remove('active');
                green.classList.add('active');
            }
        }

        // X·ª≠ l√Ω ƒë√≥ng box hi·ªÉn th·ªã th√¥ng tin email
        function closeStatsBox() {
            document.getElementById('email-stats-box').classList.remove('visible');
        }

        // G√°n h√†m cho global ƒë·ªÉ d√πng onclick="closeStatsBox()" t·ª´ HTML
        window.closeStatsBox = closeStatsBox;

        // X·ª≠ l√Ω khi ng∆∞·ªùi d√πng b·∫•m "Xem th·ªëng k√™ email"
        document.getElementById('view-email-stats').addEventListener('click', function (e) {
            e.preventDefault();

            fetch('/email-stats')
                .then(response => {
                    if (!response.ok) {
                        throw response;
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('email-address').innerText = data.email || 'Kh√¥ng c√≥';
                    document.getElementById('email-content').innerText = data.content || 'Kh√¥ng c√≥ n·ªôi dung';
                    document.getElementById('email-date').innerText = data.date || 'Kh√¥ng r√µ th·ªùi gian';
                    document.getElementById('email-stats-box').classList.add('visible');
                })
                .catch(error => {
                    let msg = 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu';
                    if (error.status === 403) msg = 'Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p';
                    document.getElementById('email-address').innerText = msg;
                    document.getElementById('email-content').innerText = 'Ki·ªÉm tra t√†i kho·∫£n ho·∫∑c m·∫°ng';
                    document.getElementById('email-date').innerText = '';
                    document.getElementById('email-stats-box').classList.add('visible');
                });
        });

        // G·ªçi ƒë·ªãnh k·ª≥ ƒë·ªÉ c·∫≠p nh·∫≠t ƒë√®n c·∫£nh b√°o m·ªói 2 gi√¢y
        fetchStatus();
        setInterval(fetchStatus, 2000);
    });
</script>

<!-- Style -->
<style>
    body {
        margin: 0;
        font-family: 'Poppins', sans-serif;
        background: linear-gradient(135deg, #1e3c72, #2a5298);
        color: #f0f0f0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        box-sizing: border-box;
    }

    .title {
        font-size: 3rem;
        font-weight: 700;
        margin-bottom: 40px;
        text-shadow: 0 2px 8px rgba(0,0,0,0.7);
    }

    .status-container {
        display: flex;
        gap: 40px;
        justify-content: center;
        margin-bottom: 50px;
        flex-wrap: wrap;
        max-width: 600px;
    }

    .status-light {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        width: 140px;
        height: 140px;
        box-shadow: 0 0 15px rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        opacity: 0.4;
        transition: transform 0.4s ease, box-shadow 0.4s ease, opacity 0.4s ease;
    }

    .status-light .icon {
        font-size: 3.5rem;
        margin-bottom: 12px;
    }

    .status-light .label {
        font-weight: 600;
        font-size: 1.1rem;
    }

    .status-light.active {
        opacity: 1;
        transform: scale(1.25);
    }

    .green.active {
        background-color: #28a745;
        box-shadow: 0 0 30px #28a745, 0 0 60px #28a745cc;
    }

    .red.active {
        background-color: #dc3545;
        box-shadow: 0 0 30px #dc3545, 0 0 60px #dc3545cc;
        animation: pulse-red 2s infinite;
    }

    @keyframes pulse-red {
        0%, 100% {
            box-shadow: 0 0 30px #dc3545, 0 0 60px #dc3545cc;
        }
        50% {
            box-shadow: 0 0 40px #ff4c4c, 0 0 80px #ff4c4ccc;
        }
    }

    .camera-container {
        width: 700px;
        max-width: 90vw;
        background: rgba(255,255,255,0.07);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        text-align: center;
    }

    .camera-feed {
        width: 100%;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.7);
        border: 3px solid rgba(255,255,255,0.15);
        background-color: #000;
    }

    #email-stats-box {
        position: fixed;
        top: 80px;
        right: -400px;
        width: 300px;
        background: #fff;
        color: #000;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0,0,0,0.3);
        z-index: 9999;
        transition: right 0.5s ease;
    }

    #email-stats-box.visible {
        right: 30px;
    }

    #email-stats-box .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #email-stats-box .close-btn {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
    }

    #email-stats-box .content {
        margin-top: 10px;
    }

    .logout-button {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 10px 20px;
        font-size: 1rem;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .logout-button:hover {
        background-color: #b02a37;
    }

    @media (max-width: 768px) {
        .status-light {
            width: 110px;
            height: 110px;
        }

        .camera-container {
            width: 100%;
            padding: 15px;
        }

        #email-stats-box {
            width: 90%;
            right: -100%;
        }

        #email-stats-box.visible {
            right: 5%;
        }
    }
</style>
{% endblock %}
